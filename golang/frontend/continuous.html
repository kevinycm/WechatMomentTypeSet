<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Continuous Layout Preview - Fake</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
            overflow-x: hidden;
        }
        .page-container {
            position: relative;
            width: 744px; /* 2480 * 0.3 */
            margin: 0 auto;
            padding: 20px;
        }
        .page {
            width: 2480px;
            height: 3508px;
            background-color: white;
            position: relative;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            transform: scale(0.3);
            transform-origin: 0 0;
            margin-bottom: -2455.6px; /* (3508 * 0.7) */
        }
        .time-display {
            position: absolute;
            font-size: 104px;
            line-height: 1.5;
            color: #2c3e50;
            font-weight: 500;
            display: flex;
            align-items: center;
        }
        .text-area {
            position: absolute;
            font-size: 50px;
            line-height: 75px;
            color: #333;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .picture-area {
            position: absolute;
            background-color: #f8f9fa;
            border: 3px solid #ecf0f1;
            box-sizing: border-box;
            overflow: hidden;
        }
        .picture-area img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .page-info {
            position: absolute;
            bottom: 100px;
            left: 100px;
            right: 100px;
            font-size: 50px;
            color: #95a5a6;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .page-number {
            color: inherit;
        }
        .year-month {
            color: inherit;
        }
        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        .zoom-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .zoom-controls button {
            padding: 5px 10px;
            margin: 0 5px;
        }
    </style>
</head>
<body>
    <div class="controls">
        <button onclick="clearPages()">Clear</button>
    </div>
    <div class="zoom-controls">
        <button onclick="zoomOut()">-</button>
        <span id="zoom-level">30%</span>
        <button onclick="zoomIn()">+</button>
    </div>
    <div id="page-container" class="page-container"></div>

    <script>
        // 全局变量
        let currentZoom = 0.3;
        const A4_WIDTH = 2480;
        const A4_HEIGHT = 3508;
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            updateZoomDisplay();
            loadData(); // 页面加载时直接获取数据
        });

        // 加载数据
        function loadData() {
            fetch('/continuous-layout-sample')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received data:', data);
                    if (!data.pages || !Array.isArray(data.pages)) {
                        throw new Error('Invalid data format: pages array is missing');
                    }
                    renderPages(data.pages);
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    alert('Error loading data: ' + error.message);
                });
        }

        // 缩放控制
        function zoomIn() {
            currentZoom = Math.min(currentZoom + 0.1, 1.0);
            updateZoom();
        }

        function zoomOut() {
            currentZoom = Math.max(currentZoom - 0.1, 0.1);
            updateZoom();
        }

        function updateZoom() {
            const container = document.getElementById('page-container');
            const pages = container.querySelectorAll('.page');
            
            // 更新容器宽度
            container.style.width = `${A4_WIDTH * currentZoom}px`;
            
            // 更新每个页面的缩放和间距
            pages.forEach((page, index) => {
                page.style.transform = `scale(${currentZoom})`;
                page.style.marginBottom = `${-A4_HEIGHT * (1 - currentZoom)}px`;
            });
            
            // 更新最后一页的margin-bottom
            if (pages.length > 0) {
                pages[pages.length - 1].style.marginBottom = '0';
            }
            
            updateZoomDisplay();
        }

        function updateZoomDisplay() {
            document.getElementById('zoom-level').textContent = `${Math.round(currentZoom * 100)}%`;
        }

        function setElementPosition(element, area) {
            const [start, end] = area;
            element.style.left = `${start[0]}px`;
            element.style.top = `${start[1]}px`;
            element.style.width = `${Math.abs(end[0] - start[0])}px`;
            element.style.height = `${Math.abs(end[1] - start[1])}px`;
        }

        function createImageErrorHandler(container, area) {
            return function() {
                container.style.display = 'flex';
                container.style.justifyContent = 'center';
                container.style.alignItems = 'center';
                container.style.fontSize = '40px';
                container.style.color = '#666';
                container.innerHTML = '图片加载失败';
            };
        }

        function createPage(pageData) {
            const page = document.createElement('div');
            page.className = 'page';

            // 处理每个条目
            pageData.entries.forEach((entry, index) => {
                // 添加时间区域
                if (entry.time && entry.time_area) {
                    const timeDiv = document.createElement('div');
                    timeDiv.className = 'time-display';
                    timeDiv.textContent = entry.time;
                    setElementPosition(timeDiv, entry.time_area);
                    page.appendChild(timeDiv);
                }

                // 添加文本区域
                if (entry.texts && entry.text_areas) {
                    entry.texts.forEach((text, i) => {
                        if (entry.text_areas[i]) {
                            const textDiv = document.createElement('div');
                            textDiv.className = 'text-area';
                            textDiv.textContent = text;
                            setElementPosition(textDiv, entry.text_areas[i]);
                            page.appendChild(textDiv);
                        }
                    });
                }

                // 添加图片区域
                if (entry.pictures) {
                    entry.pictures.forEach((picture, i) => {
                        const pictureDiv = document.createElement('div');
                        pictureDiv.className = 'picture-area';
                        setElementPosition(pictureDiv, picture.area);

                        const img = document.createElement('img');
                        img.src = picture.url;
                        img.onerror = createImageErrorHandler(pictureDiv, picture.area);
                        pictureDiv.appendChild(img);
                        page.appendChild(pictureDiv);
                    });
                }
            });

            // 添加页码信息（非插页才显示页码）
            if (!pageData.is_insert) {
                const pageInfo = document.createElement('div');
                pageInfo.className = 'page-info';
                pageInfo.innerHTML = `<span class="page-number">${pageData.page}</span>`;
                page.appendChild(pageInfo);
            }

            return page;
        }

        function renderPages(pages) {
            const container = document.getElementById('page-container');
            container.innerHTML = '';
            
            if (!pages || pages.length === 0) {
                console.error('No pages to render');
                return;
            }
            
            pages.forEach((pageData, index) => {
                const page = createPage(pageData);
                container.appendChild(page);
            });
            
            // 渲染完成后调整视图
            setTimeout(() => {
                updateZoom();
            }, 50);
        }

        function clearPages() {
            document.getElementById('page-container').innerHTML = '';
        }
    </script>
</body>
</html> 