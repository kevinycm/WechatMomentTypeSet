<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Continuous Layout Preview - Fake</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .page-container {
            width: 210mm;  /* A4 width */
            min-height: 297mm;  /* A4 height */
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin: 20px auto;
            position: relative;
            overflow: hidden;
        }
        .page {
            width: 100%;
            height: 100%;
            position: relative;
            padding: 20mm;  /* A4 margins */
            box-sizing: border-box;
        }
        .entry {
            margin-bottom: 20px;
            position: relative;
        }
        .time {
            font-size: 12pt;
            color: #666;
            margin-bottom: 10px;
        }
        .text {
            font-size: 12pt;
            line-height: 1.5;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }
        .pictures {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        .picture {
            position: relative;
            overflow: hidden;
        }
        .picture img {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }
        .controls button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .controls button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div class="controls">
    </div>
    <div id="page-container" class="page-container"></div>

    <script>
        function renderPage(page) {
            const pageDiv = document.createElement('div');
            pageDiv.className = 'page';
            
            // 按时间排序条目
            const sortedEntries = [...page.Entries].sort((a, b) => {
                return new Date(a.Time) - new Date(b.Time);
            });

            sortedEntries.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'entry';

                // 添加时间
                const timeDiv = document.createElement('div');
                timeDiv.className = 'time';
                timeDiv.textContent = new Date(entry.Time).toLocaleString();
                entryDiv.appendChild(timeDiv);

                // 添加文本
                if (entry.Texts && entry.Texts.length > 0) {
                    const textDiv = document.createElement('div');
                    textDiv.className = 'text';
                    textDiv.textContent = entry.Texts[0];
                    entryDiv.appendChild(textDiv);
                }

                // 添加图片
                if (entry.Pictures && entry.Pictures.length > 0) {
                    const picturesDiv = document.createElement('div');
                    picturesDiv.className = 'pictures';

                    entry.Pictures.forEach(pic => {
                        const pictureDiv = document.createElement('div');
                        pictureDiv.className = 'picture';
                        
                        // 设置图片容器的位置和大小
                        const area = pic.Area;
                        const left = area[0][0];
                        const top = area[0][1];
                        const width = area[1][0] - area[0][0];
                        const height = area[1][1] - area[0][1];
                        
                        pictureDiv.style.position = 'absolute';
                        pictureDiv.style.left = `${left}mm`;
                        pictureDiv.style.top = `${top}mm`;
                        pictureDiv.style.width = `${width}mm`;
                        pictureDiv.style.height = `${height}mm`;

                        const img = document.createElement('img');
                        img.src = pic.URL;
                        img.alt = `Picture ${pic.Index}`;
                        pictureDiv.appendChild(img);
                        picturesDiv.appendChild(pictureDiv);
                    });

                    entryDiv.appendChild(picturesDiv);
                }

                pageDiv.appendChild(entryDiv);
            });

            return pageDiv;
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            loadData(); // 页面加载时直接获取数据
        });

        // 加载数据
        function loadData() {
            fetch('/continuous-layout-sample')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received data:', data);
                    if (!data.pages || !Array.isArray(data.pages)) {
                        throw new Error('Invalid data format: pages array is missing');
                    }
                    renderPages(data.pages);
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    alert('Error loading data: ' + error.message);
                });
        }

        function setElementPosition(element, area) {
            const [start, end] = area;
            element.style.left = `${start[0]}px`;
            element.style.top = `${start[1]}px`;
            element.style.width = `${Math.abs(end[0] - start[0])}px`;
            element.style.height = `${Math.abs(end[1] - start[1])}px`;
        }

        function createImageErrorHandler(container, area) {
            return function() {
                container.style.display = 'flex';
                container.style.justifyContent = 'center';
                container.style.alignItems = 'center';
                container.style.fontSize = '40px';
                container.style.color = '#666';
                container.innerHTML = '图片加载失败';
            };
        }

        function createPage(pageData) {
            const page = document.createElement('div');
            page.className = 'page';

            // 处理每个条目
            pageData.entries.forEach((entry, index) => {
                // 添加时间区域
                if (entry.time && entry.time_area) {
                    const timeDiv = document.createElement('div');
                    timeDiv.className = 'time';
                    timeDiv.textContent = entry.time;
                    setElementPosition(timeDiv, entry.time_area);
                    page.appendChild(timeDiv);
                }

                // 添加文本区域
                if (entry.texts && entry.text_areas) {
                    entry.texts.forEach((text, i) => {
                        if (entry.text_areas[i]) {
                            const textDiv = document.createElement('div');
                            textDiv.className = 'text';
                            textDiv.textContent = text;
                            setElementPosition(textDiv, entry.text_areas[i]);
                            page.appendChild(textDiv);
                        }
                    });
                }

                // 添加图片区域
                if (entry.pictures) {
                    entry.pictures.forEach((picture, i) => {
                        const pictureDiv = document.createElement('div');
                        pictureDiv.className = 'picture';
                        setElementPosition(pictureDiv, picture.area);

                        const img = document.createElement('img');
                        img.src = picture.url;
                        img.onerror = createImageErrorHandler(pictureDiv, picture.area);
                        pictureDiv.appendChild(img);
                        page.appendChild(pictureDiv);
                    });
                }
            });

            // 添加页码信息（非插页才显示页码）
            if (!pageData.is_insert) {
                const pageInfo = document.createElement('div');
                pageInfo.className = 'page-info';
                pageInfo.innerHTML = `<span class="page-number">${pageData.page}</span>`;
                page.appendChild(pageInfo);
            }

            return page;
        }

        function renderPages(pages) {
            const container = document.getElementById('page-container');
            container.innerHTML = '';
            
            if (!pages || pages.length === 0) {
                console.error('No pages to render');
                return;
            }
            
            pages.forEach((pageData, index) => {
                const page = createPage(pageData);
                container.appendChild(page);
            });
        }
    </script>
</body>
</html> 